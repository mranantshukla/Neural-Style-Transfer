<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Style Transfer - Web Application</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Neural Style Transfer</h1>
            <p class="subtitle">Transform your images with artistic styles using deep learning</p>
        </header>

        <main>
            <form id="styleTransferForm" enctype="multipart/form-data">
                <!-- Content Image Section -->
                <section class="image-section">
                    <h2>Content Image</h2>
                    <div class="selection-group">
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="content_source" value="default" checked>
                                Use Default Image
                            </label>
                            <label>
                                <input type="radio" name="content_source" value="upload">
                                Upload Custom Image
                            </label>
                        </div>
                        
                        <div id="content-default" class="selection-option">
                            <select id="defaultContentSelect" name="default_content">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        
                        <div id="content-upload" class="selection-option" style="display: none;">
                            <input type="file" id="contentImageInput" name="content_image" accept="image/*">
                        </div>
                        
                        <div class="image-preview">
                            <img id="contentPreview" src="" alt="Content preview" style="display: none;">
                            <p class="preview-placeholder">Content image preview will appear here</p>
                        </div>
                    </div>
                </section>

                <!-- Style Image Section -->
                <section class="image-section">
                    <h2>Style Image</h2>
                    <div class="selection-group">
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="style_source" value="default" checked>
                                Use Default Image
                            </label>
                            <label>
                                <input type="radio" name="style_source" value="upload">
                                Upload Custom Image
                            </label>
                        </div>
                        
                        <div id="style-default" class="selection-option">
                            <select id="defaultStyleSelect" name="default_style">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        
                        <div id="style-upload" class="selection-option" style="display: none;">
                            <input type="file" id="styleImageInput" name="style_image" accept="image/*">
                        </div>
                        
                        <div class="image-preview">
                            <img id="stylePreview" src="" alt="Style preview" style="display: none;">
                            <p class="preview-placeholder">Style image preview will appear here</p>
                        </div>
                    </div>
                </section>

                <!-- Parameters Section -->
                <section class="parameters-section">
                    <h2>Generation Parameters</h2>
                    <div class="params-grid">
                        <div class="param-group">
                            <label for="epochs">Epochs:</label>
                            <input type="number" id="epochs" name="epochs" value="10" min="1" max="50">
                            <span class="param-help">Number of training iterations (1-50)</span>
                        </div>
                        
                        <div class="param-group">
                            <label for="learning_rate">Learning Rate:</label>
                            <input type="number" id="learning_rate" name="learning_rate" value="5.0" min="0.1" max="20.0" step="0.1">
                            <span class="param-help">Optimization speed (0.1-20.0)</span>
                        </div>
                        
                        <div class="param-group">
                            <label for="content_weight">Content Weight:</label>
                            <input type="number" id="content_weight" name="content_weight" value="10000" min="1000" max="100000" step="1000">
                            <span class="param-help">Preserve content structure (1000-100000)</span>
                        </div>
                        
                        <div class="param-group">
                            <label for="style_weight">Style Weight:</label>
                            <input type="number" id="style_weight" name="style_weight" value="0.01" min="0.001" max="1.0" step="0.001">
                            <span class="param-help">Apply style strength (0.001-1.0)</span>
                        </div>
                    </div>
                </section>

                <!-- Generate Button -->
                <div class="generate-section">
                    <button type="submit" id="generateBtn" class="generate-btn">
                        <span id="generateText">Generate Stylized Image</span>
                        <span id="generateLoader" class="loader" style="display: none;"></span>
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <section id="resultsSection" class="results-section" style="display: none;">
                <h2>Results</h2>
                <div class="results-grid">
                    <div class="result-item">
                        <h3>Content Image</h3>
                        <img id="resultContent" src="" alt="Content image">
                    </div>
                    <div class="result-item">
                        <h3>Style Image</h3>
                        <img id="resultStyle" src="" alt="Style image">
                    </div>
                    <div class="result-item">
                        <h3>Stylized Output</h3>
                        <img id="resultOutput" src="" alt="Stylized output">
                        <a id="downloadBtn" href="#" download class="download-btn" style="display: none;">Download Image</a>
                    </div>
                </div>
            </section>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </main>

        <footer>
            <p>Neural Style Transfer Web Application | Powered by VGG19 & TensorFlow</p>
            <p class="author-info">Developed by Anant Shukla (23113024) | Civil Engineering Dept., IIT Roorkee</p>
        </footer>
    </div>

    <script>
        // Load default images on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultImages();
            setupEventListeners();
        });

        // Load default images from API
        async function loadDefaultImages() {
            try {
                const response = await fetch('/api/default-images');
                const data = await response.json();
                
                // Populate content images dropdown
                const contentSelect = document.getElementById('defaultContentSelect');
                contentSelect.innerHTML = '<option value="">Select content image...</option>';
                data.content_images.forEach(img => {
                    const option = document.createElement('option');
                    option.value = img;
                    option.textContent = img;
                    contentSelect.appendChild(option);
                });
                
                // Populate style images dropdown
                const styleSelect = document.getElementById('defaultStyleSelect');
                styleSelect.innerHTML = '<option value="">Select style image...</option>';
                data.style_images.forEach(img => {
                    const option = document.createElement('option');
                    option.value = img;
                    option.textContent = img;
                    styleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading default images:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Content image source toggle
            document.querySelectorAll('input[name="content_source"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const defaultDiv = document.getElementById('content-default');
                    const uploadDiv = document.getElementById('content-upload');
                    if (this.value === 'default') {
                        defaultDiv.style.display = 'block';
                        uploadDiv.style.display = 'none';
                        document.getElementById('contentImageInput').value = '';
                        updateContentPreview();
                    } else {
                        defaultDiv.style.display = 'none';
                        uploadDiv.style.display = 'block';
                        document.getElementById('defaultContentSelect').value = '';
                        updateContentPreview();
                    }
                });
            });

            // Style image source toggle
            document.querySelectorAll('input[name="style_source"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const defaultDiv = document.getElementById('style-default');
                    const uploadDiv = document.getElementById('style-upload');
                    if (this.value === 'default') {
                        defaultDiv.style.display = 'block';
                        uploadDiv.style.display = 'none';
                        document.getElementById('styleImageInput').value = '';
                        updateStylePreview();
                    } else {
                        defaultDiv.style.display = 'none';
                        uploadDiv.style.display = 'block';
                        document.getElementById('defaultStyleSelect').value = '';
                        updateStylePreview();
                    }
                });
            });

            // Content image preview
            document.getElementById('defaultContentSelect').addEventListener('change', updateContentPreview);
            document.getElementById('contentImageInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('contentPreview').src = event.target.result;
                        document.getElementById('contentPreview').style.display = 'block';
                        document.querySelector('#content-default + #content-upload + .image-preview .preview-placeholder').style.display = 'none';
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // Style image preview
            document.getElementById('defaultStyleSelect').addEventListener('change', updateStylePreview);
            document.getElementById('styleImageInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('stylePreview').src = event.target.result;
                        document.getElementById('stylePreview').style.display = 'block';
                        document.querySelector('#style-default + #style-upload + .image-preview .preview-placeholder').style.display = 'none';
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // Form submission
            document.getElementById('styleTransferForm').addEventListener('submit', handleFormSubmit);
        }

        // Update content preview for default images
        function updateContentPreview() {
            const select = document.getElementById('defaultContentSelect');
            const preview = document.getElementById('contentPreview');
            const placeholder = document.querySelector('#content-default + #content-upload + .image-preview .preview-placeholder');
            
            if (select.value) {
                // For default images, we can't show preview without server-side rendering
                // Just hide placeholder
                if (placeholder) placeholder.style.display = 'none';
                preview.style.display = 'none';
            } else {
                preview.style.display = 'none';
                if (placeholder) placeholder.style.display = 'block';
            }
        }

        // Update style preview for default images
        function updateStylePreview() {
            const select = document.getElementById('defaultStyleSelect');
            const preview = document.getElementById('stylePreview');
            const placeholder = document.querySelector('#style-default + #style-upload + .image-preview .preview-placeholder');
            
            if (select.value) {
                if (placeholder) placeholder.style.display = 'none';
                preview.style.display = 'none';
            } else {
                preview.style.display = 'none';
                if (placeholder) placeholder.style.display = 'block';
            }
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Hide previous results and errors
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Show loading state
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateLoader = document.getElementById('generateLoader');
            generateBtn.disabled = true;
            generateText.textContent = 'Generating...';
            generateLoader.style.display = 'inline-block';
            
            // Prepare form data
            const formData = new FormData(document.getElementById('styleTransferForm'));
            
            // Remove file inputs if using default images
            const contentSource = document.querySelector('input[name="content_source"]:checked').value;
            const styleSource = document.querySelector('input[name="style_source"]:checked').value;
            
            if (contentSource === 'default') {
                formData.delete('content_image');
            } else {
                formData.delete('default_content');
            }
            
            if (styleSource === 'default') {
                formData.delete('style_image');
            } else {
                formData.delete('default_style');
            }
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Display results
                    document.getElementById('resultOutput').src = data.image_url;
                    
                    // Set content image source
                    const contentSource = document.querySelector('input[name="content_source"]:checked').value;
                    const contentPreview = document.getElementById('contentPreview');
                    if (contentSource === 'default') {
                        const defaultContent = document.getElementById('defaultContentSelect').value;
                        if (defaultContent) {
                            document.getElementById('resultContent').src = `/contentimage/${defaultContent}`;
                        }
                    } else if (contentPreview.src) {
                        document.getElementById('resultContent').src = contentPreview.src;
                    }
                    
                    // Set style image source
                    const styleSource = document.querySelector('input[name="style_source"]:checked').value;
                    const stylePreview = document.getElementById('stylePreview');
                    if (styleSource === 'default') {
                        const defaultStyle = document.getElementById('defaultStyleSelect').value;
                        if (defaultStyle) {
                            document.getElementById('resultStyle').src = `/style_images/${defaultStyle}`;
                        }
                    } else if (stylePreview.src) {
                        document.getElementById('resultStyle').src = stylePreview.src;
                    }
                    
                    document.getElementById('downloadBtn').href = data.image_url;
                    document.getElementById('downloadBtn').download = data.filename;
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    // Scroll to results
                    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Show error
                    document.getElementById('errorMessage').textContent = data.error || 'An error occurred';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Network error: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                generateText.textContent = 'Generate Stylized Image';
                generateLoader.style.display = 'none';
            }
        }
    </script>
</body>
</html>

